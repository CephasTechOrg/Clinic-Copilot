<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Dashboard - Clinic Co-Pilot</title>
    <script>
      (function() {
        const isFile = window.location.protocol === 'file:';
        const isBackend = window.location.origin.includes('localhost:8000') || window.location.origin.includes('127.0.0.1:8000');
        const useStatic = isFile || !isBackend;
        const baseDir = useStatic ? window.location.pathname.replace(/[^/]+$/, '') : '';
        window.APP_PATHS = {
          isFile,
          isBackend,
          useStatic,
          baseDir,
          patient: useStatic ? baseDir + 'patient.html' : '/patient',
          doctor: useStatic ? baseDir + 'doctor.html' : '/doctor',
          doctorLogin: useStatic ? baseDir + 'doctor_login.html' : '/doctor/login',
        };
      })();
    </script>
    <!-- Early auth check - redirect immediately if not logged in -->
    <script>
      (function() {
        const token = sessionStorage.getItem('clinic_copilot_token');
        const userStr = sessionStorage.getItem('clinic_copilot_user');
        if (!token || !userStr) {
          window.location.href = window.APP_PATHS ? window.APP_PATHS.doctorLogin : '/doctor/login';
          return;
        }
        try {
          const user = JSON.parse(userStr);
          if (user.role !== 'DOCTOR') {
            sessionStorage.clear();
            window.location.href = window.APP_PATHS ? window.APP_PATHS.doctorLogin : '/doctor/login';
          }
        } catch(e) {
          window.location.href = window.APP_PATHS ? window.APP_PATHS.doctorLogin : '/doctor/login';
        }
      })();
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300&display=swap" rel="stylesheet" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
              accent: { 500: '#8b5cf6', 600: '#7c3aed' },
            },
            fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out',
              'slide-up': 'slideUp 0.4s ease-out',
              'pulse-slow': 'pulse 2s infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            }
          }
        }
      }
    </script>
    <style>
      body { font-family: 'Inter', sans-serif; }
      .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
      .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
      .gradient-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
      .gradient-emerald { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
      textarea { 
        border-radius: 12px; 
        border: 1.5px solid #e2e8f0; 
        padding: 14px 16px;
        transition: all 0.2s ease;
      }
      textarea:focus {
        border-color: #3b82f6;
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      .priority-high { 
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); 
        border-color: #fca5a5; 
      }
      .priority-med { 
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); 
        border-color: #fcd34d; 
      }
      .priority-low { 
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); 
        border-color: #86efac; 
      }
      .case-card { transition: all 0.2s ease; cursor: pointer; }
      .case-card:hover { transform: translateX(4px); }
      .case-card.active { border-left: 4px solid #3b82f6; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); }
      
      /* Risk Gauge */
      .gauge-container { position: relative; width: 140px; height: 70px; overflow: hidden; }
      .gauge-bg { 
        width: 140px; 
        height: 140px; 
        border-radius: 50%; 
        background: conic-gradient(from 180deg, #22c55e 0deg, #eab308 90deg, #ef4444 180deg, transparent 180deg);
        position: absolute;
        top: 0;
      }
      .gauge-mask {
        width: 100px;
        height: 100px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 20px;
        left: 20px;
      }
      .gauge-needle {
        width: 4px;
        height: 50px;
        background: #1e293b;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform-origin: bottom center;
        transform: translateX(-50%) rotate(0deg);
        border-radius: 2px;
        transition: transform 0.8s ease-out;
      }
      .gauge-center {
        width: 16px;
        height: 16px;
        background: #1e293b;
        border-radius: 50%;
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-slate-50 via-indigo-50/20 to-purple-50/20 text-slate-900 min-h-screen">
    <!-- Decorative Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div class="absolute -top-40 -right-40 w-96 h-96 bg-indigo-200/20 rounded-full blur-3xl"></div>
      <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-purple-200/20 rounded-full blur-3xl"></div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 glass border-b border-white/30">
      <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-lg gradient-bg flex items-center justify-center shadow-md">
              <span class="material-symbols-outlined text-white text-lg">stethoscope</span>
            </div>
            <h1 class="text-base font-bold bg-gradient-to-r from-primary-600 to-accent-600 bg-clip-text text-transparent">Clinic Co-Pilot</h1>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-1.5">
              <span class="text-xs text-slate-400">Step 3/3</span>
              <div class="flex gap-0.5">
                <div class="w-6 h-1 rounded-full bg-primary-500"></div>
                <div class="w-6 h-1 rounded-full bg-primary-500"></div>
                <div class="w-6 h-1 rounded-full bg-primary-500"></div>
              </div>
            </div>
            <div class="hidden md:flex items-center gap-1.5 px-2 py-1 bg-primary-100 rounded-full">
              <span class="material-symbols-outlined text-primary-600 text-sm">auto_awesome</span>
              <span class="text-xs font-semibold text-primary-700">AI Ready</span>
            </div>
            <!-- User Info & Logout -->
            <div class="flex items-center gap-2 ml-2 pl-2 border-l border-slate-200">
              <div class="flex items-center gap-1.5">
                <span class="material-symbols-outlined text-indigo-600 text-lg">person</span>
                <span id="user-name" class="text-xs font-medium text-slate-600"></span>
              </div>
              <button onclick="AUTH.logout(window.APP_PATHS ? window.APP_PATHS.doctorLogin : '/doctor/login')" class="flex items-center gap-1 px-2 py-1 text-xs font-medium text-slate-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-sm">logout</span>
                <span class="hidden sm:inline">Logout</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="relative max-w-7xl mx-auto px-4 py-6 pb-32">
      <div class="grid gap-6 lg:grid-cols-[340px_1fr]">
        <!-- Cases Queue Panel -->
        <section class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-bold text-slate-800">Ready for Review</h2>
              <p class="text-sm text-slate-500" id="doctor-queue-subtitle">Loading cases...</p>
            </div>
            <button onclick="location.reload()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" title="Refresh">
              <span class="material-symbols-outlined text-slate-500">refresh</span>
            </button>
          </div>

          <div class="space-y-3" id="doctor-queue">
            <!-- Case cards will be inserted here -->
          </div>

          <div class="hidden text-center py-8" id="doctor-queue-empty">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
              <span class="material-symbols-outlined text-slate-400 text-3xl">check_circle</span>
            </div>
            <p class="text-slate-500 font-medium">All caught up!</p>
            <p class="text-sm text-slate-400">No pending cases to review</p>
          </div>
        </section>

        <!-- Case Review Panel -->
        <section class="space-y-5">
          <!-- Patient Info Card -->
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/50 shadow-xl shadow-slate-200/30 p-6">
            <div class="flex flex-col md:flex-row md:items-start justify-between gap-4">
              <div class="flex items-start gap-4">
                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-primary-100 to-accent-100 flex items-center justify-center flex-shrink-0">
                  <span class="material-symbols-outlined text-primary-600 text-3xl">person</span>
                </div>
                <div>
                  <h2 class="text-xl font-bold text-slate-800" id="patient-name">Select a case</h2>
                  <p class="text-sm text-slate-500" id="patient-meta">Patient ID: --</p>
                  <div class="flex items-center gap-2 mt-2">
                    <span class="material-symbols-outlined text-amber-500 text-lg">report</span>
                    <p class="text-sm font-medium text-slate-700" id="chief-complaint">--</p>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span id="priority-pill" class="px-4 py-2 rounded-full text-sm font-bold uppercase tracking-wide bg-slate-100 text-slate-600 border border-slate-200">
                  Priority
                </span>
              </div>
            </div>
          </div>

          <!-- AI Analysis Grid -->
          <div class="grid gap-5 md:grid-cols-2">
            <!-- Risk Assessment -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/50 shadow-xl shadow-slate-200/30 p-6">
              <div class="flex items-center gap-2 mb-4">
                <span class="material-symbols-outlined text-amber-500">speed</span>
                <h3 class="font-semibold text-slate-800">Risk Assessment</h3>
              </div>
              
              <div class="flex flex-col items-center">
                <div class="gauge-container">
                  <div class="gauge-bg"></div>
                  <div class="gauge-mask"></div>
                  <div class="gauge-needle" id="risk-needle"></div>
                  <div class="gauge-center"></div>
                </div>
                <div class="mt-4 text-center">
                  <p class="text-3xl font-bold" id="urgency-score">--%</p>
                  <p class="text-sm font-semibold uppercase tracking-wide" id="urgency-label">Risk Level</p>
                </div>
              </div>
            </div>

            <!-- AI Summary -->
            <div class="bg-gradient-to-br from-primary-50 to-accent-50 rounded-2xl border border-primary-100 p-6">
              <div class="flex items-center gap-2 mb-4">
                <span class="material-symbols-outlined text-primary-500">auto_awesome</span>
                <h3 class="font-semibold text-primary-800">AI Clinical Summary</h3>
              </div>
              <p class="text-sm text-primary-700 leading-relaxed" id="ai-summary">
                Select a case to view AI-generated clinical summary.
              </p>
            </div>
          </div>

          <!-- Red Flags -->
          <div class="bg-red-50/80 backdrop-blur-sm rounded-2xl border border-red-200 overflow-hidden">
            <div class="bg-gradient-to-r from-red-500 to-rose-500 px-6 py-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-white">warning</span>
              <h3 class="font-semibold text-white">Clinical Red Flags</h3>
            </div>
            <div class="p-6" id="red-flags">
              <p class="text-sm text-red-600">No red flags detected</p>
            </div>
          </div>

          <!-- Vitals & Clinical Data Grid -->
          <div class="grid gap-5 md:grid-cols-2">
            <!-- Vitals Summary -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/50 shadow-xl shadow-slate-200/30 p-6">
              <div class="flex items-center gap-2 mb-4">
                <span class="material-symbols-outlined text-teal-500">vital_signs</span>
                <h3 class="font-semibold text-slate-800">Vital Signs</h3>
              </div>
              <div class="grid grid-cols-2 gap-3" id="vitals-summary">
                <div class="text-center p-3 bg-slate-50 rounded-xl">
                  <p class="text-xs text-slate-500 font-medium">HR</p>
                  <p class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="text-center p-3 bg-slate-50 rounded-xl">
                  <p class="text-xs text-slate-500 font-medium">RR</p>
                  <p class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="text-center p-3 bg-slate-50 rounded-xl">
                  <p class="text-xs text-slate-500 font-medium">Temp</p>
                  <p class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="text-center p-3 bg-slate-50 rounded-xl">
                  <p class="text-xs text-slate-500 font-medium">SpO2</p>
                  <p class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="text-center p-3 bg-slate-50 rounded-xl col-span-2">
                  <p class="text-xs text-slate-500 font-medium">Blood Pressure</p>
                  <p class="text-lg font-bold text-slate-800">--/--</p>
                </div>
              </div>
            </div>

            <!-- Differential Considerations -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/50 shadow-xl shadow-slate-200/30 p-6">
              <div class="flex items-center gap-2 mb-4">
                <span class="material-symbols-outlined text-indigo-500">psychology</span>
                <h3 class="font-semibold text-slate-800">Differential Considerations</h3>
              </div>
              <ul class="space-y-2" id="differential-list">
                <li class="text-sm text-slate-500">--</li>
              </ul>
            </div>
          </div>

          <!-- Recommended Next Steps -->
          <div class="bg-gradient-to-r from-primary-500 to-accent-500 rounded-2xl p-6 text-white shadow-xl shadow-primary-500/25">
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined">checklist</span>
              <h3 class="font-semibold">AI Recommended Next Steps</h3>
            </div>
            <ul class="space-y-3" id="next-steps">
              <li class="flex items-start gap-2 text-sm opacity-90">
                <span class="material-symbols-outlined text-sm mt-0.5">arrow_forward</span>
                Select a case to view recommendations
              </li>
            </ul>
          </div>

          <!-- Doctor Notes -->
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/50 shadow-xl shadow-slate-200/30 p-6">
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined text-slate-500">edit_note</span>
              <h3 class="font-semibold text-slate-800">Physician Notes</h3>
            </div>
            <textarea id="doctor-note" rows="4" placeholder="Add your clinical notes, observations, and reasoning here..." class="w-full bg-white/80 resize-none"></textarea>
          </div>
        </section>
      </div>
    </main>

    <!-- Fixed Bottom Action Bar -->
    <div class="fixed bottom-0 left-0 right-0 glass border-t border-white/30 p-3 z-50">
      <div class="max-w-2xl mx-auto">
        <div class="text-center text-sm text-red-500 font-medium hidden mb-2" id="decision-error"></div>
        <div class="flex gap-3">
          <button id="decision-deny" class="flex-1 py-3 px-4 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold rounded-xl transition-all flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-xl">close</span>
            <span>Not Admitted</span>
          </button>
          <button id="decision-admit" class="flex-1 py-3 px-4 gradient-emerald text-white font-semibold rounded-xl shadow-lg shadow-emerald-500/25 hover:shadow-xl transition-all flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-xl">check</span>
            <span>Admit Patient</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 transform translate-x-[120%] transition-transform duration-300 z-[100]">
      <div class="bg-white rounded-xl shadow-2xl border border-slate-100 p-4 flex items-center gap-3 min-w-[320px]">
        <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" id="toast-icon-wrapper">
          <span class="material-symbols-outlined" id="toast-icon">check_circle</span>
        </div>
        <div>
          <p class="font-semibold text-slate-800" id="toast-title">Success</p>
          <p class="text-sm text-slate-500" id="toast-message">Operation completed</p>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] hidden flex items-center justify-center">
      <div class="bg-white rounded-2xl p-8 shadow-2xl text-center max-w-sm mx-4 animate-slide-up">
        <div class="w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center" id="modal-icon-wrapper">
          <span class="material-symbols-outlined text-white text-4xl" id="modal-icon">check</span>
        </div>
        <h3 class="font-bold text-xl text-slate-800 mb-2" id="modal-title">Decision Saved</h3>
        <p class="text-slate-500 mb-6" id="modal-message">The patient record has been updated.</p>
        <button onclick="closeModal()" class="w-full py-3 gradient-bg text-white font-semibold rounded-xl">
          Continue
        </button>
      </div>
    </div>

    <script>
      // Toast function (must be defined before doctor.js loads)
      window.showToast = function(title, message, isError = false) {
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');
        const toastIconWrapper = document.getElementById('toast-icon-wrapper');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        if (isError) {
          toastIcon.textContent = 'error';
          toastIconWrapper.className = 'w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0';
          toastIcon.className = 'material-symbols-outlined text-red-600';
        } else {
          toastIcon.textContent = 'check_circle';
          toastIconWrapper.className = 'w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0';
          toastIcon.className = 'material-symbols-outlined text-emerald-600';
        }
        
        toast.classList.remove('translate-x-[120%]');
        toast.classList.add('translate-x-0');
        
        setTimeout(() => {
          toast.classList.remove('translate-x-0');
          toast.classList.add('translate-x-[120%]');
        }, 4000);
      };

      // Success Modal function
      window.showSuccessModal = function(isAdmit) {
        const modal = document.getElementById('success-modal');
        const iconWrapper = document.getElementById('modal-icon-wrapper');
        const icon = document.getElementById('modal-icon');
        const title = document.getElementById('modal-title');
        const message = document.getElementById('modal-message');
        
        if (isAdmit) {
          iconWrapper.className = 'w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center gradient-emerald';
          icon.textContent = 'check';
          title.textContent = 'Patient Admitted Successfully';
          message.textContent = 'The patient has been admitted and the care team has been notified.';
        } else {
          iconWrapper.className = 'w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center bg-slate-200';
          icon.textContent = 'check';
          title.textContent = 'Decision Recorded';
          message.textContent = 'Patient not admitted. The decision has been saved.';
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      };

      window.closeModal = function() {
        const modal = document.getElementById('success-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        location.reload();
      };

      // Risk gauge animation
      window.setRiskGauge = function(percentage) {
        const needle = document.getElementById('risk-needle');
        // Convert percentage (0-100) to degrees (-90 to 90)
        const degrees = (percentage / 100) * 180 - 90;
        needle.style.transform = `translateX(-50%) rotate(${degrees}deg)`;
      };
    </script>
    <script src="../static/js/auth.js"></script>
    <script src="../static/js/doctor.js?v=6"></script>
  </body>
</html>
